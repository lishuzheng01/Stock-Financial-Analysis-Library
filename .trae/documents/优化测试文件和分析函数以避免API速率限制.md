## 问题分析
测试失败的主要原因是估值比率和现金流分析函数在执行时重新调用了API，导致API速率限制。这些函数没有使用测试文件中预加载的数据缓存，而是每次都重新获取数据。

## 解决方案
1. **修改分析类，支持外部数据输入**
   - 修改 `ValuationAnalyzer` 类，添加接受外部数据的参数
   - 修改 `CashFlowAnalyzer` 类，添加接受外部数据的参数
   - 允许通过构造函数或方法传入预加载的数据

2. **修改分析函数，支持数据传递**
   - 修改估值比率分析函数，支持传递外部数据
   - 修改现金流分析函数，支持传递外部数据
   - 当提供外部数据时，跳过API调用，直接使用提供的数据

3. **优化测试文件**
   - 修改测试函数，将预加载的数据传递给分析函数
   - 确保所有测试都使用缓存数据，避免重复API调用
   - 优化测试流程，提高测试效率

4. **增强错误处理**
   - 为API调用添加重试机制
   - 添加更详细的错误信息
   - 优化数据加载失败时的处理逻辑

## 实现步骤
1. 查看并修改 `ValuationAnalyzer` 类，添加数据参数支持
2. 查看并修改 `CashFlowAnalyzer` 类，添加数据参数支持
3. 修改相关分析函数，支持外部数据传递
4. 修改测试文件，将预加载的数据传递给分析函数
5. 运行测试，验证优化效果

## 预期效果
- 所有测试都使用预加载的数据缓存，避免重复API调用
- 估值比率和现金流分析测试通过
- 测试通过率显著提高
- 测试执行时间缩短

## 文件修改清单
- `src/stock_tool/ValuationRatios.py` - 修改ValuationAnalyzer类和相关函数
- `src/stock_tool/CashFlowAnalysis.py` - 修改CashFlowAnalyzer类和相关函数
- `test/test_all.py` - 修改测试函数，传递缓存数据

## 关键优化点
- 避免重复API调用，充分利用预加载的数据
- 提高测试效率和可靠性
- 增强代码的可测试性和灵活性
- 优化错误处理机制